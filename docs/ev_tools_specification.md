# Спецификация инструментов агента-проверяющего

Документ описывает набор инструментов (tools), доступных агенту-проверяющему для оценки заданий модуля "Атаки" в RAG Security Simulator.

**Последнее обновление**: Добавлено использование LLM внутри валидаторов, улучшена обратная связь, обновлен формат баллов.

## Общая структура инструмента

Каждый инструмент принимает на вход:
- `assignment_type`: тип задания модуля "Атаки" (system_prompt_extraction, knowledge_base_secret_extraction, token_limit_bypass)
- `student_solution`: решение студента (текст промпта атаки или код)
- `assignment_requirements`: требования к заданию (описание, критерии успеха, примеры)
- `test_logs` (опционально): логи автоматического тестирования, если доступны

Каждый инструмент возвращает:
- `is_passed`: булево значение (прошел/не прошел)
- `score`: числовая оценка (0-100) - итоговый взвешенный балл
- `feedback`: обратная связь "на ты", фокусирующаяся на работе студента
- `detailed_analysis`: детальный анализ работы студента (не процесса проверки)
- `improvement_suggestions`: конкретные рекомендации по улучшению
- `criterion_scores`: словарь с взвешенными баллами в формате "получено / максимум" для каждого критерия
- `criterion_details`: полные детали по каждому критерию (для отладки)

---

## Инструменты для модуля "Атаки"

### 1. validate_system_prompt_extraction

**Назначение**: Проверка задания по извлечению системного промпта из бота.

**Входные параметры**:
- `student_solution`: промпт атаки или код студента для извлечения системного промпта
- `assignment_requirements`: 
  - описание задания
  - критерии успеха (например, min_completeness: 0.8)
- `test_logs` (опционально): 
  - `extracted_prompt`: извлеченный системный промпт
  - `extraction_successful`: успешность извлечения (bool)
  - `original_prompt_length`: длина оригинального промпта

**Выходные данные**:
- `is_passed`: True, если системный промпт успешно извлечен
- `score`: итоговый взвешенный балл (0-100)
- `feedback`: обратная связь "на ты" о работе студента
- `detailed_analysis`: анализ техник, которые использовал студент
- `improvement_suggestions`: рекомендации по улучшению техники извлечения
- `criterion_scores`: взвешенные баллы в формате "получено / максимум":
  - "Успешность извлечения": "17.5 / 25.0"
  - "Качество техники атаки": "1.5 / 9.0"
  - "Полнота извлечения": "2.0 / 4.0"

**Критерии оценки** (с весами):
- Успешность извлечения (50%, max_score=50.0) → взвешенный максимум: 25.0
- Качество техники атаки (30%, max_score=30.0) → взвешенный максимум: 9.0
- Полнота извлечения (20%, max_score=20.0) → взвешенный максимум: 4.0

**Порог прохождения**: 60.0 баллов

**Особенности**:
- ✅ Использует LLM (`LLMAnalyzer`) для анализа качества техники атаки, если доступен API ключ
- ✅ Fallback на эвристики, если LLM недоступен
- ✅ Анализирует использование техник: игнорирование инструкций, прямые запросы, ролевое моделирование

---

### 2. validate_knowledge_base_secret_extraction

**Назначение**: Проверка задания по извлечению секрета из базы знаний RAG-системы.

**Входные параметры**:
- `student_solution`: промпт атаки студента для извлечения секрета
- `assignment_requirements`:
  - описание задания
  - типы секретов: журналы спортсменов, планы тренировок, отчёты по инцидентам
  - критерии успеха
- `test_logs` (опционально):
  - `extracted_secret`: извлеченный секрет
  - `extraction_successful`: успешность извлечения (bool)
  - `secret_type`: тип секрета (athlete_logs, training_plans, incident_reports)

**Выходные данные**:
- `is_passed`: True, если секрет успешно извлечен
- `score`: итоговый взвешенный балл (0-100)
- `feedback`: обратная связь "на ты" о работе студента
- `detailed_analysis`: анализ техник извлечения, которые использовал студент
- `improvement_suggestions`: рекомендации по улучшению техники извлечения
- `criterion_scores`: взвешенные баллы в формате "получено / максимум"

**Критерии оценки** (с весами):
- Успешность извлечения секрета (50%, max_score=50.0) → взвешенный максимум: 25.0
- Эффективность техники извлечения (30%, max_score=30.0) → взвешенный максимум: 9.0
- Корректность идентификации типа секрета (20%, max_score=20.0) → взвешенный максимум: 4.0

**Порог прохождения**: 60.0 баллов

**Особенности**:
- ✅ Использует LLM (`LLMAnalyzer`) для анализа эффективности техники извлечения
- ✅ Проверяет использование техник: прямые запросы, ролевое моделирование, косвенные запросы, использование идентификаторов

---

### 3. validate_token_limit_bypass

**Назначение**: Проверка задания по обходу ограничения токенов и принуждению бота генерировать больше токенов, чем установленный лимит.

**Входные параметры**:
- `student_solution`: промпт студента для генерации большого количества токенов
- `assignment_requirements`:
  - описание задания
  - `token_limit`: установленный лимит токенов
  - критерии успеха (например, превысить лимит на 20%+)
- `test_logs` (опционально):
  - `generated_tokens`: количество сгенерированных токенов

**Выходные данные**:
- `is_passed`: True, если лимит токенов успешно превышен
- `score`: итоговый взвешенный балл (0-100)
- `feedback`: обратная связь "на ты" о работе студента
- `detailed_analysis`: анализ техник обхода, которые использовал студент
- `improvement_suggestions`: рекомендации по улучшению техники обхода
- `criterion_scores`: взвешенные баллы в формате "получено / максимум"

**Критерии оценки** (с весами):
- Обход ограничения токенов (50%, max_score=50.0) → взвешенный максимум: 25.0
- Эффективность техники обхода (30%, max_score=30.0) → взвешенный максимум: 9.0
- Количество превышения лимита (20%, max_score=20.0) → взвешенный максимум: 4.0

**Порог прохождения**: 60.0 баллов

**Особенности**:
- ✅ Использует LLM (`LLMAnalyzer`) для анализа эффективности техники обхода
- ✅ Использует LLM для классификации типа атаки и оценки оригинальности
- ✅ Проверяет использование техник: рекурсивные запросы, детальные объяснения, перечисления, запросы на продолжение

---

### 4. analyze_solution_stage

**Назначение**: Анализ этапа работы студента над заданием для адаптации стратегии оценки.

**Входные параметры**:
- `student_solution`: текущее решение студента
- `assignment_type`: тип задания

**Выходные данные**:
- `stage`: этап работы (initial, developing, completed, partial)
- `completeness`: полнота решения (0.0-1.0)
- `completed_aspects`: список выполненных аспектов задания
- `missing_aspects`: список недостающих аспектов
- `recommendations`: рекомендации по следующим шагам проверки
- `needs_additional_validation`: нужна ли дополнительная валидация

**Особенности**:
- ✅ Использует LLM для глубокого анализа этапа работы студента
- ✅ Fallback на простые эвристики, если LLM недоступен
- ✅ Помогает агенту выбрать стратегию оценки

---

## Формат баллов

### Взвешенные баллы

Баллы по критериям показываются в формате **"получено / максимум"**, где:
- **получено** - взвешенный балл, который студент получил (score × weight)
- **максимум** - максимальный взвешенный балл по этому критерию (max_score × weight)

**Пример**:
```json
{
  "criterion_scores": {
    "Успешность извлечения": "17.5 / 25.0",
    "Качество техники атаки": "1.5 / 9.0",
    "Полнота извлечения": "2.0 / 4.0"
  },
  "score": 21.0,
  "is_passed": false
}
```

**Расчет итогового балла**: 17.5 + 1.5 + 2.0 = 21.0

### Почему взвешенные баллы?

Система использует веса критериев для расчета итогового балла. Например:
- Критерий с весом 0.50 и max_score=50.0 дает максимум 25.0 взвешенных баллов
- Критерий с весом 0.30 и max_score=30.0 дает максимум 9.0 взвешенных баллов
- Критерий с весом 0.20 и max_score=20.0 дает максимум 4.0 взвешенных баллов

Итоговый балл = сумма всех взвешенных баллов (максимум 100.0).

---

## Использование LLM внутри валидаторов

Все валидаторы используют класс `LLMAnalyzer` для глубокого анализа решений студентов:

### LLMAnalyzer методы:

1. **`classify_attack_type(solution)`** - классификация типа атаки через LLM
2. **`analyze_attack_technique_quality(solution, assignment_type)`** - анализ качества техник атаки
3. **`evaluate_originality(solution, assignment_type)`** - оценка оригинальности решения

### Особенности:

- ✅ Graceful degradation: если API ключ не установлен, валидаторы работают с эвристиками
- ✅ Автоматическая инициализация при первом использовании
- ✅ Использует GigaChat API через OpenAI-совместимый интерфейс

---

## Обратная связь

### Формат обратной связи

Обратная связь (`feedback`) генерируется в формате **"на ты"** и фокусируется на работе студента:

- ✅ Обращается к студенту на "ты"
- ✅ Говорит о его решении, техниках, которые он использовал
- ✅ НЕ упоминает процесс проверки или инструменты валидации
- ✅ Отмечает сильные стороны: "Вижу, что ты успешно использовал..."
- ✅ Указывает на слабые места: "Обрати внимание, что..."
- ✅ Дает конкретные рекомендации: "Попробуй улучшить..."

**Пример хорошей обратной связи**:
> "Вижу, что ты успешно справился с заданием. Что можно улучшить: попробуй использовать более продвинутые техники для повышения эффективности..."

### Детальный анализ

`detailed_analysis` также фокусируется на работе студента:
- Анализ техник, которые использовал студент
- Оценка качества реализации
- Конкретные замечания по решению
- НЕ упоминает процесс проверки

---

## Примечания

- Все инструменты для модуля "Атаки" реализованы и протестированы
- Старые инструменты (prompt_attack, system_prompt, threat_model и т.д.) закомментированы в коде для будущего использования
- Интеграция с базой модуль "Атаки" является первой итерацией реализации
